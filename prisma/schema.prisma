generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model Post {
  id          String    @id @default(cuid())
  slug        String    @unique
  title       String
  description String
  content     String?   @db.Text // 可选：用于需要同步到 DB 的场景
  coverImage  String?   // 封面图片 URL
  published   Boolean   @default(false)
  publishedAt DateTime?
  tags        Tag[]     @relation("PostTags")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  views       Int       @default(0)
  likes       Int       @default(0) // 点赞数
  comments    Comment[]
}

model Tag {
  id      String   @id @default(cuid())
  name    String   @unique
  posts   Post[]   @relation("PostTags")
  courses Course[] @relation("CourseTags")
}

model Comment {
  id        String    @id @default(cuid())
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String
  author    String
  content   String    @db.Text
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  approved  Boolean   @default(false)
  // 嵌套评论支持
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String?
  replies   Comment[] @relation("CommentReplies")

  @@index([postId])
  @@index([parentId])
}

// 教程/课程模型
model Course {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String   @db.Text
  coverImage  String?
  level       String   @default("beginner") // beginner, intermediate, advanced
  published   Boolean  @default(false)
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lessons     Lesson[]
  tags        Tag[]    @relation("CourseTags")

  @@index([published])
}

// 课程章节/课时模型
model Lesson {
  id          String   @id @default(cuid())
  slug        String
  title       String
  description String?
  content     String   @db.Text
  order       Int      @default(0) // 排序顺序
  duration    Int?     // 预计学习时长（分钟）
  published   Boolean  @default(false)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  courseId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  progress    LessonProgress[]

  @@unique([courseId, slug])
  @@index([courseId, order])
}

// 学习进度追踪（基于浏览器指纹或 localStorage）
model LessonProgress {
  visitorId String // 访客唯一标识（浏览器指纹）
  lesson    Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  lessonId  String
  completed Boolean  @default(false)
  progress  Int      @default(0) // 阅读进度百分比
  updatedAt DateTime @updatedAt

  @@id([visitorId, lessonId])
  @@index([visitorId])
}

// Newsletter 订阅者
model Subscriber {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  confirmed     Boolean   @default(false)  // 是否已确认订阅
  confirmToken  String?   @unique          // 确认 token
  unsubscribeToken String @unique @default(cuid()) // 退订 token
  createdAt     DateTime  @default(now())
  confirmedAt   DateTime?
  unsubscribedAt DateTime?

  @@index([email])
  @@index([confirmToken])
}

// 社交分享统计
model ShareStats {
  id        String   @id @default(cuid())
  postSlug  String
  platform  String   // twitter, facebook, linkedin, weibo, copy
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([postSlug, platform])
  @@index([postSlug])
}

